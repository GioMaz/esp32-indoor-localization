<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>esp32-rssi-location-estimator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        main {
            display: flex;
            flex-direction: column;
            align-items: center; /* centra orizzontalmente */
            justify-content: center; /* centra verticalmente se vuoi (opzionale) */
            height: 100vh; /* tutto l'altezza viewport */
            padding: 10px;
            box-sizing: border-box;
        }


        button {
            width: 100px;
        }

        .map-wrapper {
            width: fit-content;  /* si adatta al contenuto */
            max-width: 90vw;     /* max larghezza 90% viewport */
            max-height: 80vh;    /* max altezza 80% viewport */
            overflow-x: auto;
            overflow-y: auto;
            border: 1px solid black;
            -webkit-overflow-scrolling: touch;
            margin: auto;  /* centra in orizzontale */
        }

        .map {
            display: grid;
            grid-template-columns: repeat(var(--columns), 48px); /* celle pi√π grandi */
            grid-template-rows: repeat(var(--rows), 48px);
            gap: 0;
        }

        .box {
            width: 48px;
            height: 48px;
            border: 1px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #808080;
            text-align: center;
            font-size: 14px;
            line-height: 1.1;
            user-select: none;
            padding: 0; /* rimuoviamo il padding che decentrava il testo */
        }

        .scanned {
            background-color: #E0E0E0;
        }

        .active-default {
            background-color: #228B22 !important; /* verde scuro */
        }

        .active-scanned {
            background-color: #90EE90 !important; /* verde chiaro */
        }
    </style>
</head>

<body>
    <main>
        <h2>esp32 Indoor Localization</h2>
        <div>
            <button id="switchBtn">SWITCH STATE</button>
            <button id="resetBtn">RESET</button>
            <button id="downloadBtn">DOWNLOAD</button>
            <button id="uploadBtn">UPLOAD</button>
        </div>
        <div class="map-wrapper">
            <div class="map"></div>
        </div>
    </main>
</body>

</html>
<script>
    const base_url = "http://192.168.4.1";
    let currentState = null;

    async function initializeMap() {
        const map = document.querySelector(".map");
        map.innerHTML = ""; // pulisce la mappa prima di ridisegnarla

        const response = await fetch(base_url + "/api/map");
        const positions = await response.json();
        const padding = 5;

        let min_x, max_x, min_y, max_y;

        if (positions.length === 0) {
            min_x = -padding;
            max_x = padding;
            min_y = -padding;
            max_y = padding;
        } else {
            const [raw_min_x, raw_max_x, raw_min_y, raw_max_y] = positions.reduce(
                (acc, { x, y }) => [
                    Math.min(acc[0], x),
                    Math.max(acc[1], x),
                    Math.min(acc[2], y),
                    Math.max(acc[3], y)
                ],
                [Infinity, -Infinity, Infinity, -Infinity]
            );

            min_x = raw_min_x - padding;
            max_x = raw_max_x + padding;
            min_y = raw_min_y - padding;
            max_y = raw_max_y + padding;
        }

        const columns = max_x - min_x + 1;
        const rows = max_y - min_y + 1;

        map.style.setProperty("--columns", columns);
        map.style.setProperty("--rows", rows);

        for (let j = max_y; j >= min_y; j--) {
            for (let i = min_x; i <= max_x; i++) {
                const pos_id = `(${i},${j})`;
                const node = document.createElement("div");
                node.classList.add("box");
                node.id = pos_id;
                node.textContent = pos_id;
                map.appendChild(node);
            }
        }

        positions.forEach(({ x, y }) => {
            const node = document.getElementById(`(${x},${y})`);
            if (node) node.classList.add("scanned");
        });
    }


    initializeMap();

    // BOTTONS
    const switchBtn = document.querySelector("#switchBtn");
    const resetBtn = document.querySelector("#resetBtn");
    const downloadBtn = document.querySelector("#downloadBtn");

    switchBtn.addEventListener("click", () => {
        fetch(base_url + "/api/switch-state", { method: "POST" });
    });

    resetBtn.addEventListener("click", async () => {
        try {
            const response = await fetch(base_url + "/api/reset", { method: "POST" });
            if (!response.ok) throw new Error("Reset fallito");

            // Attendi 500 ms prima di ricaricare la mappa
            await new Promise(resolve => setTimeout(resolve, 500));

            await initializeMap();
        } catch (error) {
            console.error("Errore durante il reset:", error);
        }
    });


    downloadBtn.addEventListener("click", () => {
        const link = document.createElement("a");
        link.href = base_url + "/api/dataset";
        link.download = "dataset.bin";
        link.click();
    });

    // UPDATE ACTIVE POSITION
    setInterval(async () => {
        try {
            const {x, y} = await fetch(base_url + "/api/position").then(r => r.json());
            const id = `(${x},${y})`;
            document.querySelectorAll(".active-default, .active-scanned").forEach(el => {
                el.classList.remove("active-default", "active-scanned");
            });

            const new_active = document.getElementById(id);
            if (new_active) {
                if (new_active.classList.contains("scanned")) {
                    new_active.classList.add("active-scanned");
                } else {
                    new_active.classList.add("active-default");
                }
            }
        } catch (e) {
            console.error("Error fetching position:", e);
        }
    }, 1000);

    setInterval(() => {
        if (currentState === "training") {
            initializeMap();
        }
    }, 20000);

    // AGGIORNA STATO (ogni 2 secondi)
    async function updateStateUI() {
        try {
            const { state } = await fetch(base_url + "/api/state").then(r => r.json());
            currentState = state; 
            switchBtn.textContent = `State: ${state}`;

            if (state === "inference") {
                switchBtn.style.backgroundColor = "#4CAF50"; // green
                switchBtn.style.color = "white";
            } else if (state === "training") {
                switchBtn.style.backgroundColor = "#2196F3"; // blue
                switchBtn.style.color = "white";
            } else {
                switchBtn.style.backgroundColor = "gray";
                switchBtn.style.color = "white";
            }
        } catch (e) {
            console.error("Errore fetching stato:", e);
            switchBtn.textContent = "State: unknown";
            switchBtn.style.backgroundColor = "gray";
            switchBtn.style.color = "white";
        }
    }

    setInterval(updateStateUI, 2000); // update every 2 seconds
    updateStateUI(); // aggiorna subito all'avvio

</script>
